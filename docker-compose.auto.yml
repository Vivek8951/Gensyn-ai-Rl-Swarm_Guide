version: '3.8'

services:
  rl-swarm:
    build:
      context: .
      dockerfile: Dockerfile
    image: rl-swarm:latest
    container_name: rl-swarm-node
    # No port exposure - using system-level port forwarding
    # All access is handled by iptables/socat at the system level
    volumes:
      - swarm-data:/home/rlswarm/rl-swarm/data
      - swarm-logs:/home/rlswarm/rl-swarm/logs
      - swarm-repo:/home/rlswarm/rl-swarm
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - PATH=/home/rlswarm/rl-swarm/.venv/bin:$PATH
      - AUTO_TUNNEL=${AUTO_TUNNEL:-true}
      - TUNNEL_DOMAIN=${TUNNEL_DOMAIN:-}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
      - REMOTE_ACCESS=${REMOTE_ACCESS:-true}
      - AUTO_PORT_FORWARD=${AUTO_PORT_FORWARD:-true}
    networks:
      - rl-swarm-network
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Internal reverse proxy for advanced routing
  nginx-internal:
    image: nginx:alpine
    container_name: rl-swarm-nginx-internal
    # No external ports - internal only
    volumes:
      - ./nginx-internal.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      rl-swarm:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rl-swarm-network
    environment:
      - NGINX_PORT=80

  # Port monitor service
  port-monitor:
    image: alpine:latest
    container_name: rl-swarm-port-monitor
    command: >
      sh -c "
      apk add --no-cache curl net-tools &&
      while true; do
        echo '=== Port Status Check ===' &&
        echo 'Container ports:' &&
        netstat -tlnp | grep :3000 || echo 'Port 3000 not listening' &&
        echo 'External connectivity:' &&
        curl -s http://localhost:3000/health > /dev/null 2>&1 && echo '✅ Health check passed' || echo '❌ Health check failed' &&
        echo 'System forwards:' &&
        netstat -tlnp | grep -E ':(3000|8080|8081|8082|9000|9001|9002)' | head -5 || echo 'No external forwards detected' &&
        echo '=========================' &&
        sleep 60
      done
      "
    depends_on:
      - rl-swarm
    restart: unless-stopped
    networks:
      - rl-swarm-network

networks:
  rl-swarm-network:
    driver: bridge

volumes:
  swarm-data:
    driver: local
  swarm-logs:
    driver: local
  swarm-repo:
    driver: local