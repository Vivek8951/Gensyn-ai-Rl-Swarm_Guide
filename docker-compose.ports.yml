version: '3.8'

services:
  rl-swarm:
    build:
      context: .
      dockerfile: Dockerfile
    image: rl-swarm:latest
    container_name: rl-swarm-node
    ports:
      # RL-Swarm web interface
      - "${RL_SWARM_PORT:-3000}:3000"
      # Optional: Direct SSH access to container
      - "${CONTAINER_SSH_PORT:-2222}:22"
    volumes:
      - swarm-data:/home/rlswarm/rl-swarm/data
      - swarm-logs:/home/rlswarm/rl-swarm/logs
      - swarm-repo:/home/rlswarm/rl-swarm
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - PATH=/home/rlswarm/rl-swarm/.venv/bin:$PATH
      - AUTO_TUNNEL=${AUTO_TUNNEL:-true}
      - TUNNEL_DOMAIN=${TUNNEL_DOMAIN:-}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
      - REMOTE_ACCESS=${REMOTE_ACCESS:-true}
    networks:
      - rl-swarm-network

  # Nginx reverse proxy for multiple services
  nginx-proxy:
    image: nginx:alpine
    container_name: rl-swarm-proxy
    ports:
      # Main web interface
      - "${WEB_PORT:-80}:80"
      # Secure HTTPS interface
      - "${HTTPS_PORT:-443}:443"
      # Additional service ports
      - "${SERVICE_PORT_1:-8080}:8080"
      - "${SERVICE_PORT_2:-8081}:8081"
      - "${SERVICE_PORT_3:-8082}:8082"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - rl-swarm
    restart: unless-stopped
    networks:
      - rl-swarm-network

  # Port forwarder service for additional forwarding
  port-forwarder:
    image: alpine/socat
    container_name: rl-swarm-forwarder
    command: >
      sh -c "
      socat TCP4-LISTEN:9000,fork,reuseaddr TCP4:rl-swarm:3000 &
      socat TCP4-LISTEN:9001,fork,reuseaddr TCP4:rl-swarm:3000 &
      socat TCP4-LISTEN:9002,fork,reuseaddr TCP4:rl-swarm:3000 &
      wait
      "
    ports:
      # Alternative ports for RL-Swarm access
      - "${ALT_PORT_1:-9000}:9000"
      - "${ALT_PORT_2:-9001}:9001"
      - "${ALT_PORT_3:-9002}:9002"
    depends_on:
      - rl-swarm
    restart: unless-stopped
    networks:
      - rl-swarm-network

  # SSH tunnel service
  ssh-tunnel:
    image: alpine:latest
    container_name: rl-swarm-ssh-tunnel
    command: >
      sh -c "
      apk add --no-cache openssh-client socat &&
      while true; do
        if [ -n '${SSH_FORWARD_HOST}' ] && [ -n '${SSH_FORWARD_PORT}' ]; then
          echo 'Setting up SSH tunnel to ${SSH_FORWARD_HOST}:${SSH_FORWARD_PORT}' &&
          socat TCP4-LISTEN:${SSH_TUNNEL_PORT:-2223},fork,reuseaddr EXEC:'ssh -W ${SSH_FORWARD_HOST}:${SSH_FORWARD_PORT} ${SSH_USER:-root}@${SSH_FORWARD_HOST}'
        fi
        sleep 60
      done
      "
    ports:
      - "${SSH_TUNNEL_PORT:-2223}:2223"
    environment:
      - SSH_FORWARD_HOST=${SSH_FORWARD_HOST:-}
      - SSH_FORWARD_PORT=${SSH_FORWARD_PORT:-}
      - SSH_USER=${SSH_USER:-root}
    restart: unless-stopped
    networks:
      - rl-swarm-network

networks:
  rl-swarm-network:
    driver: bridge

volumes:
  swarm-data:
  swarm-logs:
  swarm-repo: