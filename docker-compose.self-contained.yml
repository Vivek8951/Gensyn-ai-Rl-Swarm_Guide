version: '3.8'

services:
  rl-swarm:
    build:
      context: .
      dockerfile: Dockerfile
    image: rl-swarm:latest
    container_name: rl-swarm-self-contained
    # Expose all ports that will be used by the container
    ports:
      - "3000:3000"    # Main RL-Swarm interface
      - "8080:8080"    # Alternative port 1
      - "8081:8081"    # Alternative port 2
      - "8082:8082"    # Alternative port 3
      - "9000:9000"    # Alternative port 4
      - "9001:9001"    # Alternative port 5
      - "9002:9002"    # Alternative port 6
    volumes:
      - swarm-data:/home/rlswarm/rl-swarm/data
      - swarm-logs:/home/rlswarm/rl-swarm/logs
      - swarm-repo:/home/rlswarm/rl-swarm
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - PATH=/home/rlswarm/rl-swarm/.venv/bin:$PATH
      - AUTO_TUNNEL=${AUTO_TUNNEL:-true}
      - TUNNEL_DOMAIN=${TUNNEL_DOMAIN:-}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
      - REMOTE_ACCESS=${REMOTE_ACCESS:-true}
      - SELF_CONTAINED=true
      - AUTO_PORT_FORWARD=true
    networks:
      - rl-swarm-network
    # Health check to ensure RL-Swarm is running
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  rl-swarm-network:
    driver: bridge

volumes:
  swarm-data:
    driver: local
  swarm-logs:
    driver: local
  swarm-repo:
    driver: local